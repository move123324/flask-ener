{% extends 'base.html' %}

{% block content %}
<section id="airport-section">
  <!-- 
     This container is flex-centered both horizontally & vertically, 
     so the .section-box is in the middle of the screen. 
  -->
  <div class="section-box">
    <div class="content-wrap">
      <h2>List of Airports</h2>
      
      <!-- 
        A minimal "loading spinner" 
        We'll show/hide it via JavaScript if you like, 
        or you can keep it always hidden except on form submission.
      -->
      <div id="loadingSpinner" class="spinner" style="display: none;">
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
      </div>

      <!-- Main form -->
      <form method="POST" action="/liste" onsubmit="showSpinner()">
        <label for="airport">Select your airport:</label>
        <!-- Empty option so user sees a placeholder -->
        <select name="airport_id" id="airport">
          <option value="">-- Choose an airport --</option>
          {% for airport in aeroport_list %}
            <option 
              value="{{ airport.iata_code }}"
              {% if airport.iata_code == selected_airport_id %}selected{% endif %}
            >
              {{ airport.name }}
            </option>
          {% endfor %}
        </select>
        <div style="margin-top: 10px;">
          <button type="submit">Search</button>
          <!-- 
            "Reset" button sets hidden input "reset" to "true", 
            so we can detect it in the route. 
          -->
          <button type="submit" onclick="document.getElementById('resetInput').value='true';">
            Reset
          </button>
          <input type="hidden" name="reset" id="resetInput" value="false" />
        </div>
      </form>

      <!-- Only show tables if user selected an airport -->
      {% if selected_airport_id %}
        <div style="margin-top: 40px;">
          <h3>Number of flights by aircraft type</h3>
          {% if flight_details and flight_details|length > 0 %}
            <table class="table-fixed-rows">
              <thead>
                <tr>
                  <th>Aircraft type</th>
                  <th>Number of flights</th>
                </tr>
              </thead>
              <tbody>
                {% for flight in flight_details %}
                  <tr>
                    <td>{{ flight['aircraft_type'] }}</td>
                    <td>{{ flight['total_vols'] }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <p>No flights found for this type of aircraft.</p>
          {% endif %}
        </div>

        <div style="margin-top: 40px;">
          <h3>Number of flights per day of the week</h3>
          {% if flight_by_day and flight_by_day|length > 0 %}
            <table class="table-fixed-rows">
              <thead>
                <tr>
                  <th>Day of the week</th>
                  <th>Number of flights</th>
                </tr>
              </thead>
              <tbody>
                {% for flight in flight_by_day %}
                  <tr>
                    <td>{{ flight['day_of_week'] }}</td>
                    <td>{{ flight['total_vols'] }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
            
            <!-- 
              NOTE: Chart.js 
              We'll show a bar chart for flight_by_day data 
            -->
            <canvas id="flightByDayChart" style="margin-top:20px;"></canvas>

            <!-- Script to build the bar chart -->
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              // Build arrays from the day_of_week data
              const flightByDayLabels = [
                {% for row in flight_by_day %}
                  "{{ row['day_of_week'] }}",
                {% endfor %}
              ];
              const flightByDayValues = [
                {% for row in flight_by_day %}
                  {{ row['total_vols'] }},
                {% endfor %}
              ];

              const ctx = document.getElementById('flightByDayChart');
              const flightChart = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: flightByDayLabels,
                  datasets: [{
                    label: 'Number of Flights',
                    data: flightByDayValues,
                    // backgroundColor: Optional color array or single color
                  }]
                },
                options: {
                  scales: {
                    y: {
                      beginAtZero: true
                    }
                  }
                }
              });
            </script>
          {% else %}
            <p>No flights found for this airport.</p>
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>
</section>

<style>
  /* 
     1) Remove page scroll, center container with flex. 
  */
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
  }

  #airport-section {
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    display: flex;
    align-items: center;   /* vertical center */
    justify-content: center; /* horizontal center */
  }

  .section-box {
    background-color: rgba(255, 255, 255, 0.05);
    padding: 30px;
    border-radius: 15px;
    max-width: 900px;
    width: 95%;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    text-align: center;
    text-align-last: center;
    
    /* If content is bigger than the box, 
       let it scroll inside (like a modal). */
    max-height: 90%;
    overflow: auto;
  }

  .content-wrap {
    padding: 20px 50px;
  }

  select, input[type="text"] {
    width: 100%;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
    border: none;
    background-color: white;
    color: rgb(0, 0, 0);
    font-weight: bold;
  }

  button {
    margin-top: 10px;
    padding: 8px 16px;
    background-color: #00aaff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background-color: #0088cc;
  }

  /*
     2) Table with pinned header & a scrollable body 
        that shows about ~4 rows (using 35vh or so).
  */
  .table-fixed-rows {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #fff;  /* better contrast if background is dark */
  }

  /* Slightly darker background for the header for contrast */
  .table-fixed-rows thead tr {
    display: table;
    width: 100%;
    table-layout: fixed;
    position: sticky;
    top: 0;
    background-color: rgba(255, 255, 255, 0.15);
    z-index: 5;
  }

  .table-fixed-rows thead th,
  .table-fixed-rows tbody td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .table-fixed-rows tbody {
    display: block;
    max-height: 35vh; /* ~4-5 rows visible depending on viewport */
    overflow-y: auto;
    scroll-behavior: smooth;
    width: 100%;
  }

  .table-fixed-rows tbody tr {
    display: table;
    width: 100%;
    table-layout: fixed;
  }

  /* 
     3) Minimal "loading spinner" 
  */
  .spinner {
    margin: 10px 0;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .spinner-dot {
    width: 12px;
    height: 12px;
    margin: 0 4px;
    border-radius: 50%;
    background: #00aaff;
    animation: pulse 1s infinite;
  }
  .spinner-dot:nth-child(2) {
    animation-delay: 0.2s;
  }
  .spinner-dot:nth-child(3) {
    animation-delay: 0.4s;
  }
  @keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.5); opacity: 0.5; }
    100% { transform: scale(1); opacity: 1; }
  }
</style>

{% if windows %}
<style>
  select, select option {
    background-color: #fff !important;
    color: #000 !important;
  }
</style>
{% else %}
<style>
  select, select option {
    background-color: transparent !important;
    color: #fff !important;
  }
</style>
{% endif %}

<script>
  // Show the spinner when user submits the form.
  function showSpinner() {
    document.getElementById('loadingSpinner').style.display = 'flex';
  }
</script>

{% endblock %}
